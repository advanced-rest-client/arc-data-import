<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../web-component-tester/browser.js"></script>
    <script src="../test-helper.js"></script>
    <script src="../../transformers/base-transformer.js"></script>
    <script src="../../transformers/postman-transformer.js"></script>
    <script src="../../transformers/postman-v1-transformer.js"></script>
  </head>
  <body>
    <script>
    /* global assert, DataTestHelper, PostmanV1Transformer */
    suite('postman-v1-transformer (collection)', function() {

      suite('_readProjectInfo()', function() {
        let transformer;
        let jsonData;
        let result;
        suiteSetup(function() {
          return DataTestHelper.getFile('collection-v1.json')
          .then((response) => {
            jsonData = JSON.parse(response);
          });
        });

        setup(function() {
          transformer = new PostmanV1Transformer(jsonData);
          result = transformer._readProjectInfo();
        });

        test('Returns an object', function() {
          assert.typeOf(result, 'object');
        });

        test('Contains _id', function() {
          assert.equal(result._id, 'e4638c4e-1a37-9b63-4db3-4ad8c3516706');
        });

        test('name is set', function() {
          assert.equal(result.name, 'TestCollection');
        });

        test('description is set', function() {
          assert.equal(result.description, 'Some description');
        });

        test('created is set', function() {
          assert.equal(result.created, 1518549355798);
        });

        test('updated is set', function() {
          assert.equal(result.updated, 1518549355798);
        });

        test('order is set', function() {
          assert.equal(result.order, 0);
        });
      });

      suite('_computeRequestsInOrder()', function() {
        let transformer;
        let jsonData;
        let result;
        suiteSetup(function() {
          return DataTestHelper.getFile('collection-v1.json')
          .then((response) => {
            jsonData = JSON.parse(response);
          });
        });

        setup(function() {
          transformer = new PostmanV1Transformer(jsonData);
          result = transformer._computeRequestsInOrder();
        });

        test('Returns an array', function() {
          assert.typeOf(result, 'array');
          assert.lengthOf(result, 2);
        });

        test('Requests are in order', function() {
          assert.equal(result[0].id, '6995f0d5-4c47-8bbd-de3c-1cd357e6a99d');
          assert.equal(result[1].id, '2246fd9b-169a-7051-c3e2-d2137ab90ede');
        });
      });

      suite('Data processing', function() {
        let jsonData;
        let result;
        suiteSetup(function() {
          return DataTestHelper.getFile('collection-v1.json')
          .then((response) => {
            jsonData = JSON.parse(response);
          });
        });

        setup(function() {
          const transformer = new PostmanV1Transformer(jsonData);
          return transformer.transform()
          .then((data) => result = data);
        });

        test('Returns the data', function() {
          assert.typeOf(result, 'object');
        });

        test('Contains export object properties', function() {
          assert.typeOf(result.createdAt, 'string');
          assert.equal(result.version, 'postman-collection-v1');
          assert.equal(result.kind, 'ARC#Import');
          assert.typeOf(result.projects, 'array');
          assert.typeOf(result.requests, 'array');
        });

        test('Data are accounted for', function() {
          assert.lengthOf(result.projects, 1);
          assert.lengthOf(result.requests, 2);
        });

        test('Request objects are valid', function() {
          for (let i = 0; i < result.requests.length; i++) {
            DataTestHelper.assertRequestObject(result.requests[i]);
          }
        });

        test('Project data is set', function() {
          const project = result.projects[0];
          for (let i = 0; i < result.requests.length; i++) {
            assert.typeOf(result.requests[i].projectOrder, 'number');
            assert.equal(result.requests[i].legacyProject, project._id);
          }
        });

        test('Project object is valid', function() {
          DataTestHelper.assertProjectObject(result.projects[0]);
        });

        test('Contains headersModel', function() {
          const model = result.requests[1].headersModel;
          assert.typeOf(model, 'array');
          assert.lengthOf(model, 3);
        });

        test('headersModel contains properties', function() {
          let model = result.requests[1].headersModel[0];
          assert.equal(model.name, '${h1}');
          assert.equal(model.value, '${h1v}');
          assert.isTrue(model.enabled);
          model = result.requests[1].headersModel[1];
          assert.isFalse(model.enabled);
        });

        test('Contains queryModel', function() {
          const model = result.requests[1].queryModel;
          assert.typeOf(model, 'array');
          assert.lengthOf(model, 3);
        });

        test('queryModel contains properties', function() {
          let model = result.requests[1].queryModel[0];
          assert.equal(model.name, '${p1}');
          assert.equal(model.value, '${v1}');
          assert.isTrue(model.enabled);
          model = result.requests[1].queryModel[1];
          assert.isFalse(model.enabled);
        });

        test('Variables are processed', function() {
          const model = result.requests[0];
          assert.equal(model.url, 'https://domain.com/accounts/${login}');
          assert.equal(model.headers, 'h1: h1v\n//h2: h2v\nh3: ${h3v}');
          const multipart = model.multipart;
          assert.equal(multipart[0].name, '${param}');
          assert.equal(multipart[0].value, '${value}');
          assert.equal(multipart[2].value, '${cloudhubApi}');
        });
      });
    });
    </script>

  </body>
</html>
