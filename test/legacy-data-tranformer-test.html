<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="test-helper.js"></script>
    <script src="../transformers/base-transformer.js"></script>
    <script src="../transformers/arc-legacy-transformer.js"></script>
  </head>
  <body>
    <script>
    /* global assert, DataTestHelper, ArcLegacyTransformer */
    suite('Single request import', function() {
      let jsonData;
      let result;
      suiteSetup(function() {
        return DataTestHelper.getFile('legacy-request-import.json')
        .then((response) => {
          jsonData = JSON.parse(response);
        });
      });
      setup(function() {
        const transformer = new ArcLegacyTransformer(jsonData);
        return transformer.transform()
        .then((data) => result = data);
      });

      test('Normalizes the data', function() {
        assert.typeOf(result, 'object');
      });

      test('Contains export object properties', function() {
        assert.typeOf(result.createdAt, 'string');
        assert.equal(result.version, 'unknown');
        assert.equal(result.kind, 'ARC#Import');
        assert.typeOf(result.projects, 'array');
        assert.typeOf(result.requests, 'array');
      });

      test('Projects is empty', function() {
        assert.lengthOf(result.projects, 0);
      });

      test('Requests contains a single entry', function() {
        assert.lengthOf(result.requests, 1);
      });

      test('Request object is valid', function() {
        DataTestHelper.assertRequestObject(result.requests[0]);
      });

      test('Default name is set', function() {
        assert.equal(result.requests[0].name, 'unnamed');
      });

      test('Request values are set', function() {
        const request = result.requests[0];
        assert.equal(request.url, 'http://mulesoft.com');
        assert.equal(request.method, 'GET');
        assert.equal(request.headers, '');
        assert.equal(request.payload, '');
        assert.equal(request.created, 1450675637093);
      });

      test('Google Drive information is present', function() {
        const request = result.requests[0];
        assert.equal(request.driveId, '0Bzpy9PK_RiBOeWRYUEo0TmRyTzA');
        assert.equal(request.type, 'google-drive');
      });
    });

    suite('Multiple requests import', function() {
      let jsonData;
      let result;
      suiteSetup(function() {
        return DataTestHelper.getFile('legacy-data-import.json')
        .then((response) => {
          jsonData = JSON.parse(response);
        });
      });
      setup(function() {
        const transformer = new ArcLegacyTransformer(jsonData);
        return transformer.transform()
        .then((data) => result = data);
      });

      test('Normalizes the data', function() {
        assert.typeOf(result, 'object');
      });

      test('Contains export object properties', function() {
        assert.typeOf(result.createdAt, 'string');
        assert.equal(result.version, 'unknown');
        assert.equal(result.kind, 'ARC#Import');
        assert.typeOf(result.projects, 'array');
        assert.typeOf(result.requests, 'array');
      });

      test('Projects contains an item', function() {
        assert.lengthOf(result.projects, 1);
      });

      test('Requests contains 2 entries', function() {
        assert.lengthOf(result.requests, 2);
      });

      test('Requests objects are valid', function() {
        DataTestHelper.assertRequestObject(result.requests[0]);
        DataTestHelper.assertRequestObject(result.requests[1]);
      });

      test('Projects object is valid', function() {
        DataTestHelper.assertProjectObject(result.projects[0]);
      });

      test('Project values are set', function() {
        const project = result.projects[0];
        assert.equal(project.name, 'test-project', 'name is set');
        assert.equal(project.created, 1506285256547, 'created is set');
        assert.strictEqual(project.order, 0, 'order is set');
      });

      test('Project information is set on the request', function() {
        assert.equal(result.requests[0].legacyProject, result.projects[0]._id,
          'Project ID is set');
        assert.isUndefined(result.requests[1].legacyProject, 'Project id is undefined');
      });
    });
    </script>

  </body>
</html>
